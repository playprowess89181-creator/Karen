{% load static %}
{% include "includes/head.html" %}

<!-- Preloader - style you can find in spinners.css -->
<div class="preloader">
    <div class="lds-ripple">
        <div class="lds-pos"></div>
        <div class="lds-pos"></div>
    </div>
</div>
<!-- Main wrapper - style you can find in pages.scss -->
<div id="main-wrapper">
    <!-- Topbar header - style you can find in pages.scss -->
    <header class="topbar">
        {% include "includes/navbar.html" %}
    </header>
    <!-- End Topbar header -->
    {% include "includes/aside.html" %}
    <!-- End Left Sidebar - style you can find in sidebar.scss  -->

    <!-- Page wrapper  -->
    <div class="page-wrapper">
        <!-- Container fluid  -->
        <div class="container-fluid">
            <!-- Start Page Content -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="form-body">
                            <div class="card-body">
                                <h4 class="card-title mt-2"><i class="mdi mdi-cart"></i> Cart Management</h4>
                                <hr>
                                
                                <!-- Add Customer Section -->
                                <div class="row mb-4">
                                    <div class="col-md-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">Add New Customer</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-8">
                                                        <input type="text" id="newCustomerName" class="form-control" placeholder="Enter customer name" required>
                                                    </div>
                                                    <div class="col-md-4">
                                                        <button type="button" id="addCustomerBtn" class="btn btn-primary">
                                                            <i class="fa fa-plus"></i> Add Customer
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Customers Table -->
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">Customer List</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table table-striped table-bordered" id="customersTable">
                                                        <thead>
                                                            <tr>
                                                                <th>ID</th>
                                                                <th>Customer Name</th>
                                                                <th>Created Date</th>
                                                                <th>Cart Items</th>
                                                                <th>Actions</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="customersTableBody">
                                                            <!-- Customer rows will be populated by JavaScript -->
                                                        </tbody>
                                                    </table>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Customer Modal -->
<div class="modal fade" id="editCustomerModal" tabindex="-1" role="dialog" aria-labelledby="editCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editCustomerModalLabel">Edit Customer</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editCustomerForm">
                    <div class="form-group">
                        <label for="editCustomerName">Customer Name</label>
                        <input type="text" class="form-control" id="editCustomerName" required>
                        <input type="hidden" id="editCustomerId">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveCustomerBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteCustomerModal" tabindex="-1" role="dialog" aria-labelledby="deleteCustomerModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="deleteCustomerModalLabel">Confirm Delete</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to delete customer "<span id="deleteCustomerName"></span>"?</p>
                <p class="text-danger"><small>This action cannot be undone and will also delete all associated carts.</small></p>
                <input type="hidden" id="deleteCustomerId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Delete Customer</button>
            </div>
        </div>
    </div>
</div>

{% include "includes/footer.html" %}

<script>
$(document).ready(function() {
    loadCustomers();

    // Add customer
    $('#addCustomerBtn').click(function() {
        const customerName = $('#newCustomerName').val().trim();
        if (!customerName) {
            alert('Please enter a customer name');
            return;
        }

        $.ajax({
            url: '{% url "customer_api" %}',
            method: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                'Content-Type': 'application/json',
            },
            data: JSON.stringify({
                action: 'create',
                name: customerName
            }),
            success: function(response) {
                if (response.success) {
                    $('#newCustomerName').val('');
                    loadCustomers();
                    showMessage(response.message, 'success');
                } else {
                    showMessage(response.message, 'error');
                }
            },
            error: function() {
                showMessage('Error creating customer', 'error');
            }
        });
    });

    // Edit customer
    $(document).on('click', '.edit-customer', function() {
        const customerId = $(this).data('id');
        const customerName = $(this).data('name');
        
        $('#editCustomerId').val(customerId);
        $('#editCustomerName').val(customerName);
        $('#editCustomerModal').modal('show');
    });

    // Save customer changes
    $('#saveCustomerBtn').click(function() {
        const customerId = $('#editCustomerId').val();
        const customerName = $('#editCustomerName').val().trim();
        
        if (!customerName) {
            alert('Please enter a customer name');
            return;
        }

        $.ajax({
            url: '{% url "customer_api" %}',
            method: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                'Content-Type': 'application/json',
            },
            data: JSON.stringify({
                action: 'update',
                id: customerId,
                name: customerName
            }),
            success: function(response) {
                if (response.success) {
                    $('#editCustomerModal').modal('hide');
                    loadCustomers();
                    showMessage(response.message, 'success');
                } else {
                    showMessage(response.message, 'error');
                }
            },
            error: function() {
                showMessage('Error updating customer', 'error');
            }
        });
    });

    // Delete customer
    $(document).on('click', '.delete-customer', function() {
        const customerId = $(this).data('id');
        const customerName = $(this).data('name');
        
        $('#deleteCustomerId').val(customerId);
        $('#deleteCustomerName').text(customerName);
        $('#deleteCustomerModal').modal('show');
    });

    // Confirm delete
    $('#confirmDeleteBtn').click(function() {
        const customerId = $('#deleteCustomerId').val();

        $.ajax({
            url: '{% url "customer_api" %}',
            method: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                'Content-Type': 'application/json',
            },
            data: JSON.stringify({
                action: 'delete',
                id: customerId
            }),
            success: function(response) {
                if (response.success) {
                    $('#deleteCustomerModal').modal('hide');
                    loadCustomers();
                    showMessage(response.message, 'success');
                } else {
                    showMessage(response.message, 'error');
                }
            },
            error: function() {
                showMessage('Error deleting customer', 'error');
            }
        });
    });

    // Enter key support for adding customer
    $('#newCustomerName').keypress(function(e) {
        if (e.which == 13) {
            $('#addCustomerBtn').click();
        }
    });
});

function loadCustomers() {
    $.ajax({
        url: '{% url "customer_api" %}',
        method: 'GET',
        success: function(response) {
            const tbody = $('#customersTableBody');
            tbody.empty();
            
            response.customers.forEach(function(customer) {
                const row = `
                    <tr>
                        <td>${customer.id}</td>
                        <td>${customer.name}</td>
                        <td>${customer.created_at}</td>
                        <td>
                            <span class="badge badge-info">${customer.active_cart_items} items</span>
                        </td>
                        <td>
                            <a href="/customer/${customer.id}/cart/" class="btn btn-sm btn-info" title="View Cart">
                                <i class="fa fa-shopping-cart"></i> View Cart
                            </a>
                            <button class="btn btn-sm btn-warning edit-customer" data-id="${customer.id}" data-name="${customer.name}" title="Edit Customer">
                                <i class="fa fa-edit"></i>
                            </button>
                            <button class="btn btn-sm btn-danger delete-customer" data-id="${customer.id}" data-name="${customer.name}" title="Delete Customer">
                                <i class="fa fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
                tbody.append(row);
            });
        },
        error: function() {
            showMessage('Error loading customers', 'error');
        }
    });
}

function showMessage(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    `;
    
    // Remove existing alerts
    $('.alert').remove();
    
    // Add new alert at the top of the card body
    $('.card-body').first().prepend(alertHtml);
    
    // Auto-hide after 5 seconds
    setTimeout(function() {
        $('.alert').fadeOut();
    }, 5000);
}
</script>