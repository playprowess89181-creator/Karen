{% load static %}
{% include "includes/head.html" %}

<!-- Preloader - style you can find in spinners.css -->
<div class="preloader">
    <div class="lds-ripple">
        <div class="lds-pos"></div>
        <div class="lds-pos"></div>
    </div>
</div>
<!-- Main wrapper - style you can find in pages.scss -->
<div id="main-wrapper">
    <!-- Topbar header - style you can find in pages.scss -->
    <header class="topbar">
        {% include "includes/navbar.html" %}
    </header>
    <!-- End Topbar header -->
    {% include "includes/aside.html" %}
    <!-- End Left Sidebar - style you can find in sidebar.scss  -->

    <!-- Page wrapper  -->
    <div class="page-wrapper">
        <!-- Container fluid  -->
        <div class="container-fluid">
            <!-- Start Page Content -->
            <div class="row">
                <div class="col-lg-12">
                    <div class="card">
                        <div class="form-body">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-center mb-3">
                                    <h4 class="card-title mt-2">
                                        <i class="mdi mdi-cart"></i> Cart for {{ customer.name }} (ID: {{ customer.id }})
                                    </h4>
                                    <div>
                                        <button type="button" id="importBtn" class="btn btn-dark mr-2" title="Import from Excel">
                                            <i class="fa fa-upload"></i> Import
                                        </button>
                                        <button type="button" id="exportColumnsBtn" class="btn btn-success mr-2" title="Export to Excel">
                                            <i class="fa fa-file-excel-o"></i> Export Excel
                                        </button>
                                        <button type="button" id="printColumnsBtn" class="btn btn-info mr-2" title="Print Cart">
                                            <i class="fa fa-print"></i> Print
                                        </button>
                                        <a href="{% url 'cart_management' %}" class="btn btn-secondary">
                                            <i class="fa fa-arrow-left"></i> Back to Customers
                                        </a>
                                    </div>
                                </div>
                                <hr>
                                
                                <!-- Add Product to Cart Section -->
                                <div class="row mb-4">
                                    <div class="col-md-12">
                                        <div class="card">
                                            <div class="card-header">
                                                <h5 class="card-title mb-0">Add Product to Cart</h5>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <label for="productSelect">Select Product</label>
                                                        <select class="form-control select2" id="productSelect" style="width: 100%;">
                                                            <option value="">Choose a product...</option>
                                                            {% for product in products %}
                                                                <option value="{{ product.id }}" data-code="{{ product.parent_code }}-{{ product.child_code }}" data-location="{{ product.location }}">
                                                                    {{ product.parent_code }}-{{ product.child_code }} ({{ product.location }})
                                                                </option>
                                                            {% endfor %}
                                                        </select>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label for="productQuantity">Quantity</label>
                                                        <input type="number" id="productQuantity" class="form-control" value="1" min="1">
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label>&nbsp;</label>
                                                        <button type="button" id="addToCartBtn" class="btn btn-primary form-control">
                                                            <i class="fa fa-plus"></i> Add to Cart
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Cart Details (Customer info overrides and financials) -->
                                <div class="row mb-4">
                                    <div class="col-md-12">
                                        <div class="card">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <h5 class="card-title mb-0">Cart Details</h5>
                                                <button type="button" id="saveCartDetailsBtn" class="btn btn-dark">Save Details</button>
                                            </div>
                                            <div class="card-body">
                                                <div class="row">
                                                    <div class="col-md-6">
                                                        <label for="cartAddress">Address (override)</label>
                                                        <textarea id="cartAddress" class="form-control" rows="3" placeholder="Enter shipping/billing address override"></textarea>
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label for="cartShipping">Shipping Amount</label>
                                                        <input type="number" step="0.01" id="cartShipping" class="form-control" placeholder="0.00">
                                                    </div>
                                                    <div class="col-md-3">
                                                        <label for="cartDeposit">Deposit Amount</label>
                                                        <input type="number" step="0.01" id="cartDeposit" class="form-control" placeholder="0.00">
                                                    </div>
                                                </div>
                                                <div class="row mt-3">
                                                    <div class="col-md-12">
                                                        <label for="cartNotes">Notes</label>
                                                        <textarea id="cartNotes" class="form-control" rows="2" placeholder="Optional notes for print/export"></textarea>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Cart Items Table -->
                                <div class="row">
                                    <div class="col-md-12">
                                        <div class="card">
                                            <div class="card-header d-flex justify-content-between align-items-center">
                                                <h5 class="card-title mb-0">Cart Items</h5>
                                                <div class="d-flex align-items-center">
                                                    <div class="dropdown mr-2">
                                                        <button class="btn btn-dark btn-sm dropdown-toggle" type="button" id="currencyDropdown" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                                                            <span id="currencyLabel">THB</span>
                                                        </button>
                                                        <div class="dropdown-menu" aria-labelledby="currencyDropdown">
                                                            <a class="dropdown-item select-currency" data-currency="THB" href="#">THB</a>
                                                            <a class="dropdown-item select-currency" data-currency="USD" href="#">USD</a>
                                                            <a class="dropdown-item select-currency" data-currency="EUR" href="#">EUR</a>
                                                        </div>
                                                    </div>
                                                    <button type="button" id="clearCartBtn" class="btn btn-danger btn-sm">
                                                        <i class="fa fa-trash"></i> Clear Cart
                                                    </button>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                <div class="table-responsive">
                                                    <table class="table table-striped table-bordered" id="cartItemsTable">
                                                        <thead>
                                                            <tr>
                                                                <th>Product Code</th>
                                                                <th>QTY</th>
                                                                <th>Price (Currency)</th>
                                                                <th>Amount</th>
                                                                <th>Location</th>
                                                            </tr>
                                                        </thead>
                                                        <tbody id="cartItemsTableBody">
                                                            <!-- Cart items will be populated by JavaScript -->
                                                        </tbody>
                                                    </table>
                                                </div>
                                                <div id="emptyCartMessage" class="text-center text-muted" style="display: none;">
                                                    <p><i class="fa fa-shopping-cart fa-3x"></i></p>
                                                    <p>Cart is empty. Add some products to get started!</p>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Edit Quantity Modal -->
<div class="modal fade" id="editQuantityModal" tabindex="-1" role="dialog" aria-labelledby="editQuantityModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="editQuantityModalLabel">Edit Quantity</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <form id="editQuantityForm">
                    <div class="form-group">
                        <label for="editQuantityInput">Quantity</label>
                        <input type="number" class="form-control" id="editQuantityInput" min="1" required>
                        <input type="hidden" id="editItemId">
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="saveQuantityBtn">Save Changes</button>
            </div>
        </div>
    </div>
</div>

<!-- Remove Item Confirmation Modal -->
<div class="modal fade" id="removeItemModal" tabindex="-1" role="dialog" aria-labelledby="removeItemModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="removeItemModalLabel">Confirm Remove</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Are you sure you want to remove "<span id="removeItemName"></span>" from the cart?</p>
                <input type="hidden" id="removeItemId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-danger" id="confirmRemoveBtn">Remove Item</button>
            </div>
        </div>
    </div>
</div>

<!-- Import Excel Modal -->
<div class="modal fade" id="importModal" tabindex="-1" role="dialog" aria-labelledby="importModalLabel" aria-hidden="true">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="importModalLabel">Import Cart Items from Excel</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Upload an Excel file (.xlsx) with columns: <strong>Product Code</strong> and <strong>Quantity</strong>.</p>
                <div class="form-group">
                    <label for="importFileInput">Excel File</label>
                    <input type="file" class="form-control-file" id="importFileInput" accept=".xlsx">
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="importUploadBtn"><i class="fa fa-upload"></i> Upload & Import</button>
            </div>
        </div>
    </div>
 </div>
 
<!-- Columns Selection Modal -->
<div class="modal fade" id="columnsModal" tabindex="-1" role="dialog" aria-labelledby="columnsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="columnsModalLabel">Select Columns to Include</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <p>Choose which product details to include for export or print.</p>
                <div class="row">
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="exportCols[]" id="colPicture" value="picture" checked>
                            <label class="form-check-label" for="colPicture">Picture (Print only)</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="exportCols[]" id="colProductCode" value="product_code" checked>
                            <label class="form-check-label" for="colProductCode">Product Code</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="exportCols[]" id="colName" value="name" checked>
                            <label class="form-check-label" for="colName">Name / Description</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="exportCols[]" id="colQty" value="qty" checked>
                            <label class="form-check-label" for="colQty">Quantity</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="exportCols[]" id="colPriceTHB" value="price_thb" checked>
                            <label class="form-check-label" for="colPriceTHB">Price</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="exportCols[]" id="colAmountTHB" value="amount_thb" checked>
                            <label class="form-check-label" for="colAmountTHB">Amount</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="exportCols[]" id="colWeightG" value="wt_g" checked>
                            <label class="form-check-label" for="colWeightG">WT. (g)</label>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="exportCols[]" id="colLocation" value="location" checked>
                            <label class="form-check-label" for="colLocation">Location</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="exportCols[]" id="colKPO" value="kpo" checked>
                            <label class="form-check-label" for="colKPO">KPO</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="exportCols[]" id="colPairingSet" value="pairing_set" checked>
                            <label class="form-check-label" for="colPairingSet">Pairing Set</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="exportCols[]" id="colNote1" value="note1" checked>
                            <label class="form-check-label" for="colNote1">Note 1</label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="exportCols[]" id="colNote2" value="note2" checked>
                            <label class="form-check-label" for="colNote2">Note 2</label>
                        </div>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="applyColumnsSelection">Apply</button>
            </div>
        </div>
    </div>
</div>

{% include "includes/footer.html" %}

<script>
$(document).ready(function() {
    // Initialize Select2
    $('#productSelect').select2({
        placeholder: "Choose a product...",
        allowClear: true
    });

    loadCartItems();

    // Import Excel modal
    $('#importBtn').click(function(){
        $('#importModal').modal('show');
    });
    $('#importUploadBtn').click(function(){
        const fileInput = $('#importFileInput')[0];
        if (!fileInput.files || fileInput.files.length === 0) {
            alert('Please select an Excel (.xlsx) file');
            return;
        }
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        $.ajax({
            url: '{% url "import_customer_cart_excel" customer.id %}',
            method: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            success: function(response){
                if (response.success){
                    $('#importModal').modal('hide');
                    $('#importFileInput').val('');
                    loadCartItems();
                    showMessage(response.message, 'success');
                } else {
                    showMessage(response.message || 'Import failed', 'error');
                }
            },
            error: function(){
                showMessage('Error importing Excel file', 'error');
            }
        });
    });

    // Column selection for Export / Print
    var columnsAction = null; // 'excel' or 'print'
    $('#exportColumnsBtn').on('click', function(){
        columnsAction = 'excel';
        $('#columnsModal').modal('show');
    });
    $('#printColumnsBtn').on('click', function(){
        columnsAction = 'print';
        $('#columnsModal').modal('show');
    });
    $('#applyColumnsSelection').on('click', function(){
        var cols = [];
        $('input[name="exportCols[]"]:checked').each(function(){
            cols.push($(this).val());
        });
        var colsParam = encodeURIComponent(cols.join(','));
        if(columnsAction === 'excel'){
            const currencyParam = encodeURIComponent(window.selectedCurrency || 'THB');
            window.location.href = "{% url 'export_customer_cart_excel' customer.id %}?currency=" + currencyParam + "&cols=" + colsParam;
        } else if(columnsAction === 'print'){
            const currencyParam = encodeURIComponent(window.selectedCurrency || 'THB');
            const printUrl = "{% url 'print_customer_cart' customer.id %}?currency=" + currencyParam + "&cols=" + colsParam;
            const printWindow = window.open(printUrl, '_blank');
            if (printWindow) {
                // Auto trigger print once the print page finishes loading
                printWindow.onload = function(){
                    try { printWindow.focus(); printWindow.print(); } catch(e) { /* fallback: user can click Print */ }
                };
            } else {
                alert('Popup blocked. Please allow popups for this site to print.');
            }
        }
        $('#columnsModal').modal('hide');
    });

    // Add to cart
    $('#addToCartBtn').click(function() {
        const productId = $('#productSelect').val();
        const quantity = parseInt($('#productQuantity').val());
        
        if (!productId) {
            alert('Please select a product');
            return;
        }
        
        if (quantity < 1) {
            alert('Quantity must be at least 1');
            return;
        }

        $.ajax({
            url: '{% url "cart_api" customer.id %}',
            method: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                'Content-Type': 'application/json',
            },
            data: JSON.stringify({
                action: 'add_item',
                product_id: productId,
                quantity: quantity
            }),
            success: function(response) {
                if (response.success) {
                    $('#productSelect').val('').trigger('change');
                    $('#productQuantity').val(1);
                    loadCartItems();
                    showMessage(response.message, 'success');
                } else {
                    showMessage(response.message, 'error');
                }
            },
            error: function() {
                showMessage('Error adding item to cart', 'error');
            }
        });
    });

    // Load cart info and prefill details
    function loadCartInfo() {
        $.getJSON('{% url "cart_api" customer.id %}?currency=' + encodeURIComponent(window.selectedCurrency || ''), function(resp){
            if (resp && resp.cart_info) {
                $('#cartAddress').val(resp.cart_info.address_override || '');
                $('#cartShipping').val(resp.cart_info.shipping_amount != null ? resp.cart_info.shipping_amount : '');
                $('#cartDeposit').val(resp.cart_info.deposit_amount != null ? resp.cart_info.deposit_amount : '');
                $('#cartNotes').val(resp.cart_info.notes || '');
            }
        });
    }
    loadCartInfo();

    // Save cart details
    $('#saveCartDetailsBtn').click(function(){
        const payload = {
            action: 'update_cart_info',
            address_override: $('#cartAddress').val(),
            shipping_amount: parseFloat($('#cartShipping').val() || '0') || 0,
            deposit_amount: parseFloat($('#cartDeposit').val() || '0') || 0,
            notes: $('#cartNotes').val()
        };
        $.ajax({
            url: '{% url "cart_api" customer.id %}',
            method: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                'Content-Type': 'application/json',
            },
            data: JSON.stringify(payload),
            success: function(r){
                if (r && r.success) {
                    showMessage('Cart details saved', 'success');
                } else {
                    showMessage(r && r.message ? r.message : 'Error saving details', 'error');
                }
            },
            error: function(){
                showMessage('Error saving details', 'error');
            }
        });
    });

    // Edit quantity
    $(document).on('click', '.edit-quantity', function() {
        const itemId = $(this).data('id');
        const currentQuantity = $(this).data('quantity');
        
        $('#editItemId').val(itemId);
        $('#editQuantityInput').val(currentQuantity);
        $('#editQuantityModal').modal('show');
    });

    // Save quantity changes
    $('#saveQuantityBtn').click(function() {
        const itemId = $('#editItemId').val();
        const quantity = parseInt($('#editQuantityInput').val());
        
        if (quantity < 1) {
            alert('Quantity must be at least 1');
            return;
        }

        $.ajax({
            url: '{% url "cart_api" customer.id %}',
            method: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                'Content-Type': 'application/json',
            },
            data: JSON.stringify({
                action: 'update_item',
                item_id: itemId,
                quantity: quantity
            }),
            success: function(response) {
                if (response.success) {
                    $('#editQuantityModal').modal('hide');
                    loadCartItems();
                    showMessage(response.message, 'success');
                } else {
                    showMessage(response.message, 'error');
                }
            },
            error: function() {
                showMessage('Error updating quantity', 'error');
            }
        });
    });

    // Remove item
    $(document).on('click', '.remove-item', function() {
        const itemId = $(this).data('id');
        const itemName = $(this).data('name');
        
        $('#removeItemId').val(itemId);
        $('#removeItemName').text(itemName);
        $('#removeItemModal').modal('show');
    });

    // Confirm remove
    $('#confirmRemoveBtn').click(function() {
        const itemId = $('#removeItemId').val();

        $.ajax({
            url: '{% url "cart_api" customer.id %}',
            method: 'POST',
            headers: {
                'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                'Content-Type': 'application/json',
            },
            data: JSON.stringify({
                action: 'remove_item',
                item_id: itemId
            }),
            success: function(response) {
                if (response.success) {
                    $('#removeItemModal').modal('hide');
                    loadCartItems();
                    showMessage(response.message, 'success');
                } else {
                    showMessage(response.message, 'error');
                }
            },
            error: function() {
                showMessage('Error removing item', 'error');
            }
        });
    });

    // Clear cart
    $('#clearCartBtn').click(function() {
        if (confirm('Are you sure you want to clear the entire cart? This action cannot be undone.')) {
            $.ajax({
                url: '{% url "cart_api" customer.id %}',
                method: 'POST',
                headers: {
                    'X-CSRFToken': $('[name=csrfmiddlewaretoken]').val(),
                    'Content-Type': 'application/json',
                },
                data: JSON.stringify({
                    action: 'clear_cart'
                }),
                success: function(response) {
                    if (response.success) {
                        loadCartItems();
                        showMessage(response.message, 'success');
                    } else {
                        showMessage(response.message, 'error');
                    }
                },
                error: function() {
                    showMessage('Error clearing cart', 'error');
                }
            });
        }
    });
});

function loadCartItems() {
    $.ajax({
        url: '{% url "cart_api" customer.id %}?currency=' + encodeURIComponent(window.selectedCurrency || 'THB'),
        method: 'GET',
        success: function(response) {
            const tbody = $('#cartItemsTableBody');
            tbody.empty();
            
            if (response.cart_items.length === 0) {
                $('#cartItemsTable').hide();
                $('#emptyCartMessage').show();
                $('#clearCartBtn').prop('disabled', true);
            } else {
                $('#cartItemsTable').show();
                $('#emptyCartMessage').hide();
                $('#clearCartBtn').prop('disabled', false);
                
                response.cart_items.forEach(function(item) {
                    const priceDisplay = (item.currency_note && item.price !== null)
                        ? `${item.currency_note} ${Number(item.price).toFixed(2)}`
                        : '-';
                    const amountDisplay = (item.currency_note && item.amount !== null)
                        ? `${item.currency_note} ${Number(item.amount).toFixed(2)}`
                        : '-';
                    const row = `
                        <tr>
                            <td>
                                <strong>${item.product_code}</strong>
                                <button class="btn btn-sm btn-danger remove-item ml-2" data-id="${item.id}" data-name="${item.product_code}" title="Remove Item">
                                    <i class="fa fa-trash"></i>
                                </button>
                            </td>
                            <td>
                                <span class="badge badge-primary">${item.quantity}</span>
                                <button class="btn btn-sm btn-warning edit-quantity ml-2" data-id="${item.id}" data-quantity="${item.quantity}" title="Edit Quantity">
                                    <i class="fa fa-edit"></i>
                                </button>
                            </td>
                            <td>${priceDisplay}</td>
                            <td>${amountDisplay}</td>
                            <td>${item.product_location}</td>
                        </tr>
                    `;
                    tbody.append(row);
                });
            }
        },
        error: function() {
            showMessage('Error loading cart items', 'error');
        }
    });
}

// Currency selector
window.selectedCurrency = 'THB';
$(document).on('click', '.select-currency', function(e){
    e.preventDefault();
    const c = $(this).data('currency');
    window.selectedCurrency = c;
    $('#currencyLabel').text(c);
    loadCartItems();
});

function showMessage(message, type) {
    const alertClass = type === 'success' ? 'alert-success' : 'alert-danger';
    const alertHtml = `
        <div class="alert ${alertClass} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                <span aria-hidden="true">&times;</span>
            </button>
        </div>
    `;
    
    // Remove existing alerts
    $('.alert').remove();
    
    // Add new alert at the top of the card body
    $('.card-body').first().prepend(alertHtml);
    
    // Auto-hide after 5 seconds
    setTimeout(function() {
        $('.alert').fadeOut();
    }, 5000);
}
</script>
